# Printer Data Repository - GitHub Actions Workflow
# ==================================================
# Automatically updates the printer database weekly from upstream sources.
#
# Schedule: Every Sunday at 00:00 UTC
# Manual trigger: workflow_dispatch
#
# Sources:
#   - OrcaSlicer (FDM printers)
#   - UVtools (SLA printers)

name: Update Printer Database

on:
  # Scheduled weekly update (Sundays at midnight UTC)
  schedule:
    - cron: '0 0 * * 0'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'true'

jobs:
  update-database:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      # Step 1: Checkout the repository
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Set up Python
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Step 3: Install dependencies
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Run the build script
      - name: ðŸ”§ Build Printer Database
        run: python main_build.py

      # Step 5: Check for changes
      - name: ðŸ” Check for Changes
        id: changes
        run: |
          git diff --quiet data/ || echo "changes=true" >> $GITHUB_OUTPUT

      # Step 6: Commit and push changes
      - name: ðŸ“¤ Commit and Push
        if: steps.changes.outputs.changes == 'true' || github.event.inputs.force_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Auto-update printer database [skip ci]"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions <actions@github.com>"
          file_pattern: "data/*"
          push_options: '--force-with-lease'

      # Step 7: Summary
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ–¨ï¸ Printer Database Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f data/metadata.json ]; then
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Printers | $(jq '.total_printers' data/metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| FDM | $(jq '.fdm_count' data/metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| SLA | $(jq '.sla_count' data/metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| With Images | $(jq '.with_images' data/metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Brands | $(jq '.brand_count' data/metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Last Updated | $(jq -r '.last_updated' data/metadata.json) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Metadata file not found" >> $GITHUB_STEP_SUMMARY
          fi
